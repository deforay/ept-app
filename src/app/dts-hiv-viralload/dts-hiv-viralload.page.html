<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>
      Dried Tube Specimen - HIV Viral Load
    </ion-title>
  </ion-toolbar>
</ion-header>


<ion-content>
  <p *ngIf="viewAccessMessage">{{viewAccessMessage}}</p>
  <mat-accordion class="example-headers-align">
    <mat-expansion-panel [expanded]="step === 0" (opened)="setStep(0)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Participant Details
        </mat-panel-title>
      </mat-expansion-panel-header>

      <ion-grid>
        <ion-row *ngIf="partDetailsArray.participantName">
          <ion-col size="5" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">Participant Name </span>
            </p>
          </ion-col>
          <ion-col size="1" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">:</span>
            </p>
          </ion-col>
          <ion-col class="grid-readonly-col">
            <p text-wrap>
              <span>{{partDetailsArray.participantName}}</span>
            </p>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="partDetailsArray.participantCode">
          <ion-col size="5" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">Participant Code </span>
            </p>
          </ion-col>
          <ion-col size="1" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">:</span>
            </p>
          </ion-col>
          <ion-col class="grid-readonly-col">
            <p text-wrap>
              <span>{{partDetailsArray.participantCode}}</span>
            </p>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="partDetailsArray.affiliation">
          <ion-col size="5" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">Affiliation </span>
            </p>
          </ion-col>
          <ion-col size="1" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">:</span>
            </p>
          </ion-col>
          <ion-col class="grid-readonly-col">
            <p text-wrap>
              <span> {{partDetailsArray.affiliation}}</span>
            </p>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="partDetailsArray.phone">
          <ion-col size="5" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">Phone No </span>
            </p>
          </ion-col>
          <ion-col size="1" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">:</span>
            </p>
          </ion-col>
          <ion-col class="grid-readonly-col">
            <p text-wrap>
              <span>{{partDetailsArray.phone}}</span>
            </p>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="partDetailsArray.mobile">
          <ion-col size="5" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">Mobile No</span>
            </p>
          </ion-col>
          <ion-col size="1" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">:</span>
            </p>
          </ion-col>
          <ion-col class="grid-readonly-col">
            <p text-wrap>
              <span>{{partDetailsArray.mobile}}</span>
            </p>
          </ion-col>
        </ion-row>
      </ion-grid>
      <mat-action-row>
        <button mat-button color="primary" (click)="nextStep()">Next</button>
      </mat-action-row>
    </mat-expansion-panel>

    <mat-expansion-panel [expanded]="step === 1" (opened)="setStep(1)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Shipment Details
        </mat-panel-title>

      </mat-expansion-panel-header>

      <ion-grid>
        <ion-row *ngIf="shipmentsDetailsArray.shipmentDate">
          <ion-col size="5" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">Shipment Date </span>
            </p>
          </ion-col>
          <ion-col size="1" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">:</span>
            </p>
          </ion-col>
          <ion-col class="grid-readonly-col">
            <p text-wrap>
              <span>{{shipmentsDetailsArray.shipmentDate}}</span>
            </p>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="shipmentsDetailsArray.resultDueDate">
          <ion-col size="5" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">Result Due Date </span>
            </p>
          </ion-col>
          <ion-col size="1" class="grid-readonly-col">
            <p text-wrap>
              <span class="text-title-color">:</span>
            </p>
          </ion-col>
          <ion-col class="grid-readonly-col">
            <p text-wrap>
              <span>{{shipmentsDetailsArray.resultDueDate}}
              </span>
            </p>
          </ion-col>
        </ion-row>
      </ion-grid>
      <ion-grid>
        <ion-row>
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Test Receipt Date</mat-label>
              <input matInput [matDatepicker]="testReceiptPicker" class="datepicker-input"[(ngModel)]="testReceiptDate"
                placeholder="Choose Test Receipt date" required >
              <mat-datepicker-toggle matSuffix [for]="testReceiptPicker"></mat-datepicker-toggle>
              <mat-datepicker #testReceiptPicker disabled="false"></mat-datepicker>
              <mat-error *ngIf="!testReceiptDate">Please Choose Test Receipt Date. Eg: 28-Feb-2020</mat-error>


            </mat-form-field>
          </ion-col>
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Sample Rehydration Date</mat-label>
              <input matInput [matDatepicker]="sampleRhdPicker" [(ngModel)]="sampleRhdDate" placeholder="Choose a date"
                required>
              <mat-datepicker-toggle matSuffix [for]="sampleRhdPicker"></mat-datepicker-toggle>
              <mat-datepicker #sampleRhdPicker disabled="false"></mat-datepicker>
              <mat-error *ngIf="!sampleRhdDate">Please Choose Test Sample Rehydration Date.</mat-error>
              <!-- <mat-error *ngIf="!sampleRhdDate" style="margin-bottom:10px">Eg: 28-Feb-2020</mat-error> -->

            </mat-form-field>
          </ion-col>

          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Testing Date</mat-label>
              <input matInput [matDatepicker]="testDatePicker" [(ngModel)]="testDate" placeholder="Choose a date"
                required >
              <mat-datepicker-toggle matSuffix [for]="testDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #testDatePicker disabled="false"></mat-datepicker>
              <mat-error *ngIf="!testDate">Please Choose Testing Date. Eg: 28-Feb-2020</mat-error>

            </mat-form-field>
          </ion-col>
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Viral Load Assay </mat-label>
              <mat-select [(ngModel)]="vlassay" name="vlassay" (ngModelChange)="changeViralLoadAssay(vlassay)" required>
                <mat-option>--Select--</mat-option>
                <mat-option *ngFor="let vl of shipmentsDetailsArray['vlAssaySelect']" [value]="vl.value">
                  {{vl.show}}
                </mat-option>
              </mat-select>

              <mat-error *ngIf="!vlassay">Please choose Viral Load Assay </mat-error>
            </mat-form-field>

          </ion-col>
          <ion-col size="6" size-xs *ngIf="isSelectedOther" class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Please specify Other Assay Name </mat-label>
              <input matInput [(ngModel)]="othervlassay" placeholder="Enter Other Assay Name" required>
              <mat-error *ngIf="!othervlassay">Please specify Other Assay Name </mat-error>
            </mat-form-field>

          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Specimen Volume used for testing</mat-label>
              <input matInput [(ngModel)]="specVolTest" placeholder="Enter Specimen Volume">
            </mat-form-field>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Assay Expiration Date</mat-label>
              <input matInput [matDatepicker]="assayExpiryDate" [(ngModel)]="assayExpDate" placeholder="Choose a date"
                required >
              <mat-datepicker-toggle matSuffix [for]="assayExpiryDate"></mat-datepicker-toggle>
              <mat-datepicker #assayExpiryDate disabled="false"></mat-datepicker>
              <mat-error *ngIf="!assayExpDate">Please Choose Testing Date. Eg: 28-Feb-2020</mat-error>

            </mat-form-field>
          </ion-col>
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Assay Lot Number</mat-label>
              <input matInput [(ngModel)]="assayLotNo" placeholder="Enter Assay Lot Number">
            </mat-form-field>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Response Date</mat-label>
              <input matInput [matDatepicker]="respDate" placeholder="Choose a date" [(ngModel)]="responseDate" required>
              <mat-datepicker-toggle matSuffix [for]="respDate"></mat-datepicker-toggle>
              <mat-datepicker #respDate disabled="false"></mat-datepicker>
              <mat-error *ngIf="!responseDate">Please Choose Testing Date. Eg: 28-Feb-2020</mat-error>
            </mat-form-field>
          </ion-col>

          
          <ion-col size="6" size-xs class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Mode of Receipt</mat-label>
              <mat-select [(ngModel)]="receiptmode" name="receiptmode" required>
                <mat-option>--Select--</mat-option>
                <mat-option *ngFor="let item of modeOfReceiptArray" [value]="item.value">
                  {{item.show}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="!receiptmode">Please choose the Mode Of Receipt </mat-error>
            </mat-form-field>
          </ion-col>
        </ion-row>
        <ion-row *ngIf="isQCDoneShow">
          <ion-col size="12">
            <mat-label style="margin-left: 10px;">QC Done</mat-label>
            <mat-radio-group aria-labelledby="example-radio-group-label" class="login-full-width grid-col-form"
              [(ngModel)]="qcDone">
              <mat-radio-button class="example-radio-button" *ngFor="let qcData of qcRadioArray" [value]="qcData.value">
                {{qcData.show}}
              </mat-radio-button>
            </mat-radio-group>
          </ion-col>
        </ion-row>


        <ion-row *ngIf="isQCDoneShow && qcDone=='yes'">
          <ion-col size="12">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>QC Date</mat-label>
              <input matInput [matDatepicker]="qcDatePicker" [(ngModel)]="qcDate" placeholder="Choose a date" required
                >
              <mat-datepicker-toggle matSuffix [for]="qcDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #qcDatePicker disabled="false"></mat-datepicker>
            </mat-form-field>
          </ion-col>
          <ion-col size="12">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>QC Done By </mat-label>
              <input matInput [(ngModel)]="qcDoneBy" placeholder="">
            </mat-form-field>
          </ion-col>
        </ion-row>
      </ion-grid>

      <mat-action-row>
        <button mat-button color="primary" (click)="prevStep()">Previous</button>
        <button mat-button color="warn" (click)="nextStep()">Next</button>
      </mat-action-row>
    </mat-expansion-panel>

    <mat-expansion-panel [expanded]="step === 2" (opened)="setStep(2)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          PT Panel Test
        </mat-panel-title>
      </mat-expansion-panel-header>
      <ion-row>
        <ion-col class="grid-input-col">
          <section class="div-section">
            <mat-checkbox [(ngModel)]="ptPanelTest">PT panel not tested</mat-checkbox>
          </section>
        </ion-col>
      </ion-row>
      <section *ngIf="ptPanelTest==false || !ptPanelTest">
        <ion-row>
          <ion-col class="grid-input-col">
            <section class="div-section">
              <p>Please Note :</p>
              <ul>
                <li *ngFor="let item of ptPanelTestData.notes">
                <div innerHtml="{{item}}"></div> 
                </li>
              </ul>
            </section>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>{{ptPanelTestArray.vlResultSectionLabel}}
              </mat-label>
              <input matInput [(ngModel)]="vlCalc" placeholder="Enter result value to calculate log value"
                (ngModelChange)="calcLog()">
            </mat-form-field>
            <p class="log-para">{{vlLog}}</p>
          </ion-col>
        </ion-row>
        <div *ngIf="ptPanelTestData.controlArray">
          <mat-card class="dynamic-card" *ngFor="let controls of ptPanelTestData.controlArray.label ;let i = index">
            <mat-card-title>
              {{controls}} <span class="danger-text" *ngIf="ptPanelTestData.controlArray.mandatory[i]==true">*</span>
            </mat-card-title>
            <mat-card-content>
           
                <div *ngFor="let check of ptPanelTestArray.vlResult;let k = index">
                  <ion-row>
                  <ion-col  class="grid-input-col" *ngIf="k==i">
                    <p class="no-padding" style="margin-top: 0;">
                      {{ptPanelTestData.controlHeads[ptPanelTestData.controlHeads.length-3]}}
                    </p>
                    <mat-form-field class="login-full-width " appearance="outline">
                      <mat-label><div [innerHTML]="ptPanelTestData.controlHeads[ptPanelTestData.controlHeads.length-2]"></div></mat-label>
                      <input matInput [disabled]="ptPanelTestData.tndArray[i]=='yes'"
                       [required]="ptPanelTestData.controlArray.mandatory[i]==true && (ptPanelTest==false || !ptPanelTest)"
                        [(ngModel)]="ptPanelTestData.vlResult[k]" placeholder="Viral Load (log10 copies/ml)">
                     <mat-error *ngIf="ptPanelTestData.controlArray.mandatory[i]==true && !ptPanelTestData.vlResult[k] && (ptPanelTest==false || !ptPanelTest)">
                       Please Enter {{ptPanelTestData.controlHeads[ptPanelTestData.controlHeads.length-2]}}</mat-error>

                    </mat-form-field>
                  </ion-col>
                </ion-row>
                </div>
              
            
                <div *ngFor="let item of ptPanelTestData.tndRadioArray;let j= index">
                  <ion-row>
                  <ion-col  class="grid-input-col" *ngIf="j==i">
                    <p class="no-padding" style="margin-top: 0;">
                      {{ptPanelTestData.controlHeads[ptPanelTestData.controlHeads.length-1]}}
                    </p>
                    <mat-radio-group aria-labelledby="example-radio-group-label" class="example-radio-group"
                      [(ngModel)]="ptPanelTestData.tndArray[j]" (ngModelChange)="changeTND(j,ptPanelTestData.tndArray[j])" 
                      [required]="ptPanelTestData.controlArray.mandatory[i]==true && (ptPanelTest==false || !ptPanelTest) ">
                      <mat-radio-button class="example-radio-button" 
                      *ngFor="let tnd of item"
                        [value]="tnd.value">
                        {{tnd.show}} 
                      </mat-radio-button>
                      <mat-error *ngIf="ptPanelTestData.controlArray.mandatory[i]==true && !ptPanelTestData.tndArray[j] && (ptPanelTest==false || !ptPanelTest)">
                        Please Enter {{ptPanelTestData.controlHeads[ptPanelTestData.controlHeads.length-1]}}</mat-error>
                    </mat-radio-group>
                  </ion-col>
               

              </ion-row>
            </div>
            </mat-card-content>
          </mat-card>

        </div>
      </section>
      <section *ngIf="ptPanelTest">
        <ion-row>
          <ion-col size="12" class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>
                {{ptPanelNotTestData.ptNotTestedReasonLabel}} </mat-label>
              <mat-select [(ngModel)]="ptPanelNotTestData.vlNotTestedReason" name="vlNotTested" [required]="ptPanelTest">
                <mat-option>--Select--</mat-option>
                <mat-option *ngFor="let item of ptPanelNotTestData.ptNotTestedReasonArray" [value]="item.value">
                  {{item.show}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="!ptPanelNotTestData.vlNotTestedReason && ptPanelTest">Please choose the Reason for not testing</mat-error>
            </mat-form-field>
          </ion-col>
          <ion-col size="12" class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>{{ptPanelNotTestData.ptNotTestedCommentsLabel}}</mat-label>
              <textarea matInput placeholder="Enter Your Comments here" [(ngModel)]="ptPanelNotTestData.ptNotTestedComments"
              [required]="ptPanelTest"></textarea>
              <mat-error *ngIf="!ptPanelNotTestData.ptNotTestedComments && ptPanelTest">Please Enter Your Comments</mat-error>
            </mat-form-field>
          </ion-col>
          <ion-col size="12" class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>{{ptPanelNotTestData.ptSupportCommentsLabel}}</mat-label>
              <textarea matInput placeholder="Enter Your Comments here" [(ngModel)]="ptPanelNotTestData.ptSupportComments"
              [required]="ptPanelTest"></textarea>
              <mat-error *ngIf="!ptPanelNotTestData.ptSupportComments && ptPanelTest">Please Enter Your Comments</mat-error>
            </mat-form-field>
          </ion-col>
        </ion-row>
      </section>
      <mat-action-row>
        <button mat-button color="warn" (click)="prevStep()">Previous</button>
        <button mat-button color="primary" (click)="nextStep()">Next</button>
      </mat-action-row>
    </mat-expansion-panel>

    <mat-expansion-panel [expanded]="step === 3" (opened)="setStep(3)">
      <mat-expansion-panel-header>
        <mat-panel-title>
          Other Informations
        </mat-panel-title>

      </mat-expansion-panel-header>

      <ion-grid>
        <ion-row>
          <ion-col class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Supervisor Review </mat-label>
              <mat-select [(ngModel)]="supReview" name="supReview" (ngModelChange)="changeSupervisorReview(supReview)">
                <mat-option>--Select--</mat-option>
                <mat-option *ngFor="let sr of supervisorReviewArray" [value]="sr.value">
                  {{sr.show}}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </ion-col>
          <ion-col *ngIf="supReview=='yes'" class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>{{approvalLabel }}</mat-label>
              <input matInput [(ngModel)]="supName" placeholder="Enter Supervisor Name">
            </mat-form-field>
          </ion-col>
        </ion-row>
        <ion-row>
          <ion-col class="grid-input-col">
            <mat-form-field class="login-full-width grid-col-form" appearance="outline">
              <mat-label>Comments</mat-label>
              <textarea matInput placeholder="Enter Comments here" [(ngModel)]="comments"></textarea>
            </mat-form-field>
          </ion-col>
        </ion-row>

      </ion-grid>

      <mat-action-row>
        <button mat-button color="primary" (click)="prevStep()">Previous</button>
        <button mat-button color="warn" (click)="submitViralLoad()">Submit</button>
      </mat-action-row>
    </mat-expansion-panel>
  </mat-accordion>


</ion-content>